# --- COPY CODE NÃ€Y VÃ€O GOOGLE COLAB Äá»‚ CHáº Y ---
# ÄÃ¢y lÃ  tool "BÆ¡m MÃ¡u" dá»¯ liá»‡u cho Server Render yáº¿u (512MB RAM)
# Cháº¡y 1 láº§n vÃ o Ä‘áº§u ngÃ y (8h sÃ¡ng) Ä‘á»ƒ náº¡p dá»¯ liá»‡u ná»n táº£ng 1 nÄƒm.

# 1. CÃ i Ä‘áº·t thÆ° viá»‡n cáº§n thiáº¿t
!pip install yfinance pandas requests

import yfinance as yf
import pandas as pd
import numpy as np
import requests
import json
from datetime import datetime, timedelta

# --- Cáº¤U HÃŒNH ---
# THAY Äá»”I URL NÃ€Y THÃ€NH LINK SERVER Cá»¦A Báº N (VD: https://quant-app.onrender.com)
SERVER_URL = "https://YOUR-APP-URL.onrender.com"  
API_ENDPOINT = f"{SERVER_URL}/api/upload-oracle"

# Danh sÃ¡ch VN30
VN30_LIST = ["ACB.VN", "BCM.VN", "BID.VN", "BVH.VN", "CTG.VN", "FPT.VN", "GAS.VN", "GVR.VN", "HDB.VN", "HPG.VN", "MBB.VN", "MSN.VN", "MWG.VN", "PLX.VN", "POW.VN", "SAB.VN", "SHB.VN", "SSB.VN", "SSI.VN", "STB.VN", "TCB.VN", "TPB.VN", "VCB.VN", "VHM.VN", "VIB.VN", "VIC.VN", "VJC.VN", "VNM.VN", "VPB.VN", "VRE.VN"]
FULL_LIST = VN30_LIST + ["^VNINDEX"]

def run_oracle_extraction():
    print("â³ Äang táº£i dá»¯ liá»‡u 1 nÄƒm tá»« Yahoo Finance...")
    try:
        # 1. Táº£i dá»¯ liá»‡u 1 nÄƒm
        data = yf.download(FULL_LIST, period="1y", progress=False, auto_adjust=False)['Adj Close']
        
        # Datetime fix
        data.index = data.index.strftime('%Y-%m-%d')
        
        # Xá»­ lÃ½ náº¿u thiáº¿u VNINDEX
        if "^VNINDEX" not in data.columns:
            print("âš ï¸ Thiáº¿u VNINDEX, Ä‘ang táº¡o chá»‰ sá»‘ giáº£ láº­p...")
            valid = [c for c in data.columns if c in VN30_LIST]
            data["^VNINDEX"] = data[valid].mean(axis=1)
            
        data = data.ffill().dropna()
        print(f"âœ… ÄÃ£ táº£i: {data.shape[0]} dÃ²ng x {data.shape[1]} cá»™t")
        
        # 2. TÃ­nh toÃ¡n cÃ¡c chá»‰ sá»‘ "Ná»n táº£ng" (Oracle Base)
        
        # A. MA200 (DÃ¹ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh Xu hÆ°á»›ng dÃ i háº¡n)
        ma200 = data.rolling(window=200).mean().iloc[-1].to_dict()
        
        # B. Price T-20 (GiÃ¡ 20 ngÃ y trÆ°á»›c - DÃ¹ng Ä‘á»ƒ tÃ­nh Momentum)
        if len(data) > 20:
            price_t20 = data.iloc[-20].to_dict()
        else:
            price_t20 = data.iloc[0].to_dict()
            
        # C. Market Momentum History (DÃ¹ng Ä‘á»ƒ xáº¿p háº¡ng Percentile)
        # TÃ­nh Return trung bÃ¬nh cá»§a rá»• VN30
        basket_cols = [c for c in data.columns if c != "^VNINDEX"]
        basket_ret = data[basket_cols].pct_change().mean(axis=1)
        mom_curve = basket_ret.rolling(window=20).mean() * 20
        # Láº¥y 250 ngÃ y gáº§n nháº¥t
        mom_history = mom_curve.dropna().tail(252).values.tolist()
        
        # D. Market Breadth T-1 (Äá»™ rá»™ng thá»‹ trÆ°á»ng hÃ´m qua)
        # Sá»‘ mÃ£ > MA10
        bench = data["^VNINDEX"]
        beats = 0
        total = 0
        for t in VN30_LIST:
            if t in data.columns:
                rs = 100 * (data[t] / bench) # Relative Strength
                rs_ma = rs.rolling(10).mean()
                if rs_ma.iloc[-1] > 100: beats += 1
                total += 1
        breadth_t1 = beats / total if total > 0 else 0.5
        
        # E. Recent Prices (30-40 ngÃ y gáº§n nháº¥t)
        # Äá»ƒ Server váº½ biá»ƒu Ä‘á»“ RRG Trail vÃ  tÃ­nh toÃ¡n ngáº¯n háº¡n
        recent_df = data.tail(40)
        recent_json = recent_df.to_json(date_format='iso') # Serialize DataFrame
        
        # 3. ÄÃ³ng gÃ³i Payload
        payload = {
            "ma200_map": ma200,
            "price_t20_map": price_t20,
            "mom_history_array": mom_history,
            "breadth_t1": breadth_t1,
            "recent_prices_json": recent_json
        }
        
        print("ğŸš€ Äang báº¯n dá»¯ liá»‡u lÃªn Server Render...")
        headers = {'Content-Type': 'application/json'}
        response = requests.post(API_ENDPOINT, data=json.dumps(payload), headers=headers)
        
        if response.status_code == 200:
            print("âœ… THÃ€NH CÃ”NG! Server Ä‘Ã£ nháº­n Oracle.")
            print("Server pháº£n há»“i:", response.json())
        else:
            print(f"âŒ THáº¤T Báº I: {response.status_code}")
            print(response.text)
            
    except Exception as e:
        print(f"âŒ Lá»–I NGHIÃŠM TRá»ŒNG: {str(e)}")

# CHáº Y
run_oracle_extraction()
